<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        .estaciones {
            background-color: #fff; 
        }
        #map {
            height: 550px;
        }
        #csvData {
            height: 400px;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <title>Proyecto de Software</title>
</head>
<body class="d-flex flex-column min-vh-100">

    <!-- Encabezado -->
    <header class="d-flex align-items-center border p-3">
        <div class="logos">
            <img src="{% static 'home/Logo1.png' %}" alt="Logo" width="60" height="auto">
            <img src="{% static 'home/Logo2.png' %}" alt="Logo2" width="250" height="auto">
        </div>
        <div class="ml-auto d-flex align-items-center">
            <a href="{% url 'body' %}" class="btn gradient-btn mr-3" style="color: #651616; font-size: 17px;"><strong>Inicio</strong></a>
            <a href="{% url 'contacto' %}" class="btn gradient-btn mr-3" style="color: #651616; font-size: 17px;"><strong>Contacto</strong></a>
            <div class="input-group" style="margin-right: 20px;">
                <input type="text" class="form-control form-control-lg" placeholder="Buscar...">
                <div class="input-group-append">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
            </div>
        </div>        
    </header>

    <!-- Barra de navegación en el aside -->
    <aside>
        <nav class="navbar navbar-expand-lg navbar-light" style="background: linear-gradient(to right, #8a2626, #300707); box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1); height: 50px;">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item mx-5">
                    <a class="nav-link" href="pronostico_mp10.html" style="color: #fff; padding: 5px; font-size: 18px; font-weight: bold;">Pronóstico MP10</a>
                </li>
                <li class="nav mx-5">
                    <a class="nav-link estaciones" href="estaciones.html" style="color: #000; padding: 5px; font-size: 18px; font-weight: bold;">Estaciones</a>
                </li>
                <li class="nav-item mx-5">
                    <a class="nav-link" href="datos_historicos.html" style="color: #fff; padding: 5px; font-size: 18px; font-weight: bold;">Datos Históricos</a>
                </li>
            </ul>
        </nav>
    </aside>

    <main class="container mt-5">
        <div id="formContainer" class="card col-md-8 shadow mx-auto">
            <div class="card-header gradient-estaciones">
                <h3 class="mb-0">Seleccionar Estación</h3>
            </div>
            <div class="card-body">
                <form id="selectionForm">
                    <div class="form-group">
                        <label for="Estacion">Estacion:</label>
                        <select class="form-control" id="sector">
                            <option value="" disabled selected>Selecciona una estación</option>
                            <option class="disabled-option" value="Andacollo" disabled>-- Andacollo --</option>
                            <option value="Andacollo">Andacollo</option>
                            <option value="Chepiquilla">Chepiquilla</option>
                            <option value="ElSauce">El Sauce</option>
                            <option value="Hospital">Hospital</option>
                            <option value="Urmenetra">Urmenetra</option>
                            <option class="disabled-option" value="LosVilos" disabled>-- Los Vilos --</option>
                            <option value="Caimanes">Caimanes</option>
                            <option value="Chacay">Chacay</option>
                            <option value="ElMauro">El Mauro</option>
                            <option value="PuntaChungo">Punta Chungo</option>
                            <option class="disabled-option" value="Salamanca" disabled>-- Salamanca --</option>
                            <option value="Camisas">Camisas</option>
                            <option value="Coiron">Coiron</option>
                            <option value="Cuncumen">Cuncumen</option>
                            <option value="HotelMina">Hotel Mina</option>
                            <option value="QuelenAlto">Quelen Alto</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Buscar</button>
                </form>
            </div>
        </div>

        <div id="resultContainer" class="card col-md-12 shadow mx-auto" style="display: none;">
            <button id="backButton" class="btn btn-secondary mt-3"><i class="fas fa-arrow-left"></i> Volver</button>
            <div class="row">
                <div id="map" class="col-md-8 card-body"></div>
                <div id="csvData" class="col-md-4 card-body"></div>
            </div>
        </div>
    </main>
    
    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <!-- Leaflet.js -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        var map;
    
        // Función para mostrar el resultado y ocultar el formulario
        function mostrarCsvCard(event) {
            event.preventDefault(); // Previene el envío predeterminado del formulario
    
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'block';
    
            var sector = document.getElementById('sector').value;
            cargarCsvData(sector);
    
            setTimeout(function() {
                if (!map) {
                    // Inicializar el mapa Leaflet
                    map = L.map('map').setView([51.505, -0.09], 13); // Cambia las coordenadas y el nivel de zoom según tus necesidades
    
                    // Agregar una capa de mapa base de Google Maps
                    L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                        maxZoom: 20,
                        subdomains:['mt0','mt1','mt2','mt3'],
                        attribution: 'Map data &copy; <a href="https://www.google.com/">Google</a>',
                        apiKey: 'YOUR_GOOGLE_MAPS_API_KEY' // Aquí debes colocar tu clave de API
                    }).addTo(map);
                } else {
                    map.invalidateSize();
                }
            }, 100); // Esperar 100 ms para asegurarse de que el contenedor del mapa esté visible
        }
    
        // Función para cargar datos del CSV
        function cargarCsvData(sector) {
            var csvFilePath = `/static/csv_files/coordenadas/${sector}.csv`;
            $.get(csvFilePath, function(data) {
                var lines = data.split('\n');
                var html = '<table class="table table-striped"><thead><tr>';

                // Crear encabezados de la tabla
                var headers = lines[0].split(',');
                headers.forEach(function(header) {
                    html += '<th>' + header + '</th>';
                });
                html += '</tr></thead><tbody>';

                // Crear filas de la tabla
                for (var i = 1; i < lines.length; i++) {
                    var row = lines[i].split(',');
                    html += '<tr>';
                    row.forEach(function(cell) {
                        html += '<td>' + cell + '</td>';
                    });
                    html += '</tr>';
                }
                html += '</tbody></table>';

                // Mostrar la tabla en el contenedor csvData
                document.getElementById('csvData').innerHTML = html;

                // Busca la línea que contiene las coordenadas
                var coordenadas;
                for (var i = 0; i < lines.length; i++) {
                    if (lines[i].startsWith('Coordenadas')) {
                        coordenadas = lines[i].split(',')[1].trim();
                        break;
                    }
                }

                if (coordenadas) {
                    var latlng = coordenadas.split(' ');
                    var lat = parseFloat(latlng[0]);
                    var lng = parseFloat(latlng[1]);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        if (!map) {
                            // Inicializar el mapa Leaflet
                            map = L.map('map').setView([lat, lng], 13);

                            // Agregar una capa de mapa base de Google Maps
                            L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                                maxZoom: 20,
                                subdomains:['mt0','mt1','mt2','mt3'],
                                attribution: 'Map data &copy; <a href="https://www.google.com/">Google</a>',
                                apiKey: 'YOUR_GOOGLE_MAPS_API_KEY' // Aquí debes colocar tu clave de API
                            }).addTo(map);
                        } else {
                            map.setView([lat, lng], 13);
                        }

                        // Agregar marcador al mapa
                        L.marker([lat, lng]).addTo(map)
                            .bindPopup(`<b>${sector}</b><br>Coordenadas: ${lat}, ${lng}`)
                            .openPopup();
                    } else {
                        console.error('Error al leer las coordenadas del archivo CSV.');
                    }
                } else {
                    console.error('No se encontraron coordenadas en el archivo CSV.');
                }
            });
        }
    
        // Función para retroceder al formulario
        function retrocederFormulario() {
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('formContainer').style.display = 'block';
        }
    
        // Asigna el evento submit al formulario
        document.getElementById('selectionForm').addEventListener('submit', mostrarCsvCard);
    
        // Asigna el evento clic al botón de retroceso
        document.getElementById('backButton').addEventListener('click', retrocederFormulario);
    </script>

    <!-- Pie de página -->
    <footer class="mt-auto py-3" style="background-color: #8a2626; color: #fff; text-align: center;">
        <div class="container">
            <p class="mb-0">&copy; 2024 Proyecto de Software</p>
        </div>
    </footer>
    
</body>
</html>
